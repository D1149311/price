<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Prices</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>Product Prices</h1>

<canvas id="priceChart" width="800" height="400"></canvas>

<script>
  async function fetchPrices() {
    try {
      const response = await fetch('http://localhost:3001/prices');
      const data = await response.json();

      const products = {};
      const years = ['2020', '2021', '2022', '2023', '2024']; // 年份范围

      // 数据处理
      data.forEach(entry => {
        if (!products[entry.name]) {
          products[entry.name] = { labels: [], data: [] };
        }
        products[entry.name].labels.push(entry.year.toString()); // 确保年份是字符串
        products[entry.name].data.push(entry.price);
      });

      const ctx = document.getElementById('priceChart').getContext('2d');

      // 构建数据集
      const datasets = Object.keys(products).map(productName => ({
        label: productName,
        data: fillMissingValues(products[productName].labels, products[productName].data, years),
        fill: false,
        borderColor: getRandomColor() // 随机颜色
      }));

      // 初始化图表
      const priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years, // 使用手动设置的年份范围作为标签
          datasets: datasets
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }

  // 填充缺失的值
  function fillMissingValues(labels, data, years) {
    const filledData = [];
    years.forEach(year => {
      const index = labels.indexOf(year);
      if (index !== -1) {
        filledData.push(data[index]);
      } else {
        filledData.push(null); // 添加 null 表示缺失的数据
      }
    });
    return filledData;
  }

  // 生成随机颜色
  function getRandomColor() {
    return '#' + Math.floor(Math.random() * 16777215).toString(16);
  }

  // 调用函数获取数据并绘制图表
  fetchPrices();
</script>
</body>
</html>
